# å¤©ç½¡ Â· WAF (Tiangang WAF)

å¤©ç½¡æ˜¯ä¸€æ¬¾è‡ªç ”å¯æ‰©å±•çš„è¾¹ç¼˜ WAF å’Œåå‘ä»£ç†ï¼ŒåŸºäº Workerman + pfinal-asyncio çš„é«˜å¹¶å‘æ··åˆæ¶æ„ã€‚
ç›®æ ‡ï¼šæä¾›ä¼ä¸šçº§çš„è‡ªæ‰˜ç®¡é˜²æŠ¤èƒ½åŠ›ï¼ˆè§„åˆ™ç®¡ç†ã€åŠ¨æ€æŒ‘æˆ˜ã€è¯¯æŠ¥å›æ”¾ä¸å®¡è®¡ï¼‰ï¼Œä¾¿äºç°åº¦å¯ç”¨ä¸è§„åˆ™çƒ­æ›´æ–°ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **é«˜æ€§èƒ½ä»£ç†**ï¼šåŸºäº Workerman çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹
- **æ··åˆæ¶æ„**ï¼šæ ¸å¿ƒåŠŸèƒ½åŒæ­¥ + åå°ä»»åŠ¡å¼‚æ­¥
- **å¼‚æ­¥è§„åˆ™å¼•æ“**ï¼šä½¿ç”¨ pfinal-asyncio è¿›è¡Œå¹¶å‘æ£€æµ‹
- **Webç®¡ç†ç•Œé¢**ï¼šç°ä»£åŒ–å“åº”å¼ç®¡ç†æ§åˆ¶å°
- **è§„åˆ™çƒ­åŠ è½½**ï¼šæ”¯æŒåŠ¨æ€æ›´æ–°æ£€æµ‹è§„åˆ™
- **äº‹ä»¶é‡‡æ ·ä¸å®¡è®¡**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç›‘æ§
- **å¯æ‰©å±•æ’ä»¶æœºåˆ¶**ï¼šç±»ä¼¼ SafeLine çš„æ’ä»¶ç³»ç»Ÿ
- **ç¦»çº¿æ¨¡å¼**ï¼šæ— éœ€æ•°æ®åº“å³å¯è¿è¡Œ

## ğŸ—ï¸ æ¨èéƒ¨ç½²

```
è¾¹ç¼˜ï¼ˆTLS ç»ˆç»“ï¼‰â†’ å¤©ç½¡ï¼ˆæ•°æ®å¹³é¢ï¼‰â†’ åç«¯ï¼ˆWebman/åº”ç”¨ï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
composer install
```

### é…ç½®ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

```bash
cp env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ•°æ®åº“å’Œ Redisï¼ˆå¯é€‰ï¼Œæ”¯æŒç¦»çº¿æ¨¡å¼ï¼‰
```

**ç¦»çº¿æ¨¡å¼**ï¼šå¦‚æœä¸é…ç½®æ•°æ®åº“ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›å…¥ç¦»çº¿æ¨¡å¼ï¼Œä½¿ç”¨æ–‡ä»¶å­˜å‚¨å’Œç¡¬ç¼–ç çš„é»˜è®¤è´¦æˆ·ã€‚è¯¦è§ [ç¦»çº¿æ¨¡å¼æ–‡æ¡£](docs/OFFLINE_MODE.md)

### å¯åŠ¨æœåŠ¡

```bash
php start.php start
```

### è®¿é—®æœåŠ¡

```bash
# è®¿é—®ç™»å½•é¡µé¢
curl http://localhost:8787/admin/login

# ç™»å½•ç®¡ç†ç•Œé¢ï¼ˆéœ€è¦è®¤è¯ï¼‰
curl http://localhost:8787/admin

# è®¿é—®APIæ¥å£
curl http://localhost:8787/api/dashboard

# å¥åº·æ£€æŸ¥
curl http://localhost:8787/health
```

### ğŸŒ Webç®¡ç†ç•Œé¢

è®¿é—® `http://localhost:8787/admin/login` ç™»å½•ç®¡ç†ç•Œé¢ï¼š

#### ğŸ” ç™»å½•ç³»ç»Ÿ
- **ç°ä»£åŒ–ç™»å½•ç•Œé¢**ï¼šåŸºäºFigmaè®¾è®¡çš„å“åº”å¼ç•Œé¢
- **å¤šç”¨æˆ·æ”¯æŒ**ï¼šç®¡ç†å‘˜ã€WAFç®¡ç†å‘˜ã€å¤©ç½¡ç®¡ç†å‘˜
- **ä¼šè¯ç®¡ç†**ï¼šå®‰å…¨çš„Cookieä¼šè¯å’Œè‡ªåŠ¨è¿‡æœŸ
- **è®°ä½æˆ‘åŠŸèƒ½**ï¼šæ”¯æŒé•¿æœŸç™»å½•çŠ¶æ€

#### ğŸ“Š ç®¡ç†åŠŸèƒ½
- **å®æ—¶ç›‘æ§**ï¼šè¯·æ±‚ç»Ÿè®¡ã€æ‹¦æˆªç‡ã€å“åº”æ—¶é—´
- **å®‰å…¨æŠ¥å‘Š**ï¼šå¨èƒåˆ†æã€æ”»å‡»ç»Ÿè®¡
- **æ€§èƒ½åˆ†æ**ï¼šç³»ç»ŸçŠ¶æ€ã€èµ„æºä½¿ç”¨
- **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒJSONã€CSVã€XMLæ ¼å¼

#### ğŸ‘¥ é»˜è®¤è´¦æˆ·

**ç¦»çº¿æ¨¡å¼**ï¼ˆæœªé…ç½®æ•°æ®åº“æ—¶ï¼‰ï¼š
| ç”¨æˆ·å | å¯†ç  | è¯´æ˜ |
|--------|------|------|
| `admin` | `admin123` | ç®¡ç†å‘˜è´¦æˆ· |
| `waf` | `waf2024` | WAFç®¡ç†å‘˜ |
| `tiangang` | `tiangang2024` | å¤©ç½¡ç®¡ç†å‘˜ |

**æ•°æ®åº“æ¨¡å¼**ï¼ˆé…ç½®æ•°æ®åº“åï¼‰ï¼š
- è¿è¡Œ `php database/install.php` åˆå§‹åŒ–æ•°æ®åº“
- é»˜è®¤è´¦æˆ·åŒä¸Šï¼Œä½†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- å¯ä»¥é€šè¿‡æ•°æ®åº“ç®¡ç†ç”¨æˆ·è´¦æˆ·

> ğŸ’¡ **æç¤º**ï¼šç”Ÿäº§ç¯å¢ƒåº”é…ç½®æ•°æ®åº“ï¼Œä¸è¦ä¾èµ–ç¡¬ç¼–ç è´¦æˆ·ã€‚è¯¦è§ [ç¦»çº¿æ¨¡å¼æ–‡æ¡£](docs/OFFLINE_MODE.md)

### ğŸ§ª æµ‹è¯•åŠŸèƒ½

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
php tests/run_unit_tests.php

# è¿è¡Œé›†æˆæµ‹è¯•
php tests/run_all_tests.php

# æ€§èƒ½åŸºå‡†æµ‹è¯•
php tests/performance/benchmark.php

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
php tests/coverage_report.php
```

### ğŸ”§ è§„åˆ™ç®¡ç†

```bash
# æµ‹è¯•WAFè§„åˆ™
curl "http://localhost:8787/?test=<script>alert('xss')</script>"

# æµ‹è¯•SQLæ³¨å…¥æ£€æµ‹
curl "http://localhost:8787/?id=1' OR '1'='1"

# æµ‹è¯•é¢‘ç‡é™åˆ¶
for i in {1..10}; do curl http://localhost:8787/; done
```

## âš¡ æ€§èƒ½ç‰¹ç‚¹

### æ··åˆæ¶æ„ä¼˜åŠ¿

| ç‰¹æ€§ | åŒæ­¥æ ¸å¿ƒ | å¼‚æ­¥åå° | æ··åˆæ¶æ„ |
|------|----------|----------|----------|
| **ç¨³å®šæ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | â­â­ | â­â­â­â­ |
| **æ‰©å±•æ€§** | â­â­ | â­â­â­â­â­ | â­â­â­â­ |

### ğŸš€ æŠ€æœ¯ä¼˜åŠ¿

- **æ··åˆæ¶æ„**ï¼šæ ¸å¿ƒåŠŸèƒ½åŒæ­¥å¤„ç†ï¼Œåå°ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
- **é«˜æ€§èƒ½**ï¼šåŸºäºWorkermanäº‹ä»¶é©±åŠ¨æ¨¡å‹
- **å¼‚æ­¥æ£€æµ‹**ï¼šä½¿ç”¨pfinal-asyncioè¿›è¡Œå¹¶å‘æ£€æµ‹
- **ç¦»çº¿æ¨¡å¼**ï¼šæ— éœ€æ•°æ®åº“å³å¯è¿è¡Œ
- **ç°ä»£åŒ–UI**ï¼šå“åº”å¼Webç®¡ç†ç•Œé¢

## ğŸ“ é¡¹ç›®ç»“æ„

```
å¤©ç½¡WAF/
â”œâ”€â”€ ğŸšª å…¥å£å±‚
â”‚   â”œâ”€â”€ start.php              # æœåŠ¡å™¨å¯åŠ¨å…¥å£
â”‚   â””â”€â”€ app/waf/               # WAFæ ¸å¿ƒæ¨¡å—
â”‚       â””â”€â”€ TiangangGateway.php # æ ¸å¿ƒç½‘å…³
â”‚
â”œâ”€â”€ ğŸ›¡ï¸ WAFæ ¸å¿ƒå±‚
â”‚   â”œâ”€â”€ app/waf/middleware/    # WAFä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ WafMiddleware.php
â”‚   â”œâ”€â”€ app/waf/detectors/     # æ£€æµ‹å™¨
â”‚   â”‚   â”œâ”€â”€ QuickDetector.php  # å¿«é€Ÿæ£€æµ‹
â”‚   â”‚   â””â”€â”€ AsyncDetector.php  # å¼‚æ­¥æ£€æµ‹
â”‚   â”œâ”€â”€ app/waf/core/          # æ ¸å¿ƒç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ WafResult.php      # æ£€æµ‹ç»“æœ
â”‚   â”‚   â”œâ”€â”€ DecisionEngine.php # å†³ç­–å¼•æ“
â”‚   â”‚   â””â”€â”€ CoroutinePool.php  # åç¨‹æ± 
â”‚   â”œâ”€â”€ app/waf/logging/       # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ AsyncLogger.php    # å¼‚æ­¥æ—¥å¿—
â”‚   â”‚   â””â”€â”€ LogCollector.php   # æ—¥å¿—æ”¶é›†
â”‚   â”œâ”€â”€ app/waf/monitoring/    # ç›‘æ§ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ MetricsCollector.php
â”‚   â”œâ”€â”€ app/waf/performance/   # æ€§èƒ½åˆ†æ
â”‚   â”‚   â””â”€â”€ PerformanceDashboard.php
â”‚   â”œâ”€â”€ app/waf/plugins/       # æ’ä»¶ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ PluginManager.php
â”‚   â”‚   â””â”€â”€ WafPluginInterface.php
â”‚   â”œâ”€â”€ app/waf/proxy/         # ä»£ç†è½¬å‘
â”‚   â”‚   â”œâ”€â”€ ProxyHandler.php
â”‚   â”‚   â””â”€â”€ BackendManager.php
â”‚   â”œâ”€â”€ app/waf/config/        # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ ConfigManager.php
â”‚   â”œâ”€â”€ app/waf/cache/         # ç¼“å­˜ç®¡ç†
â”‚   â”‚   â””â”€â”€ AsyncCacheManager.php
â”‚   â”œâ”€â”€ app/waf/database/      # æ•°æ®åº“ç®¡ç†
â”‚   â”‚   â””â”€â”€ AsyncDatabaseManager.php
â”‚   â””â”€â”€ app/waf/optimization/  # æ€§èƒ½ä¼˜åŒ–
â”‚       â””â”€â”€ PerformanceOptimizer.php
â”‚
â”œâ”€â”€ ğŸŒ ç®¡ç†ç•Œé¢å±‚
â”‚   â”œâ”€â”€ app/admin/controller/  # ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ AuthController.php     # è®¤è¯æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ DashboardController.php # ä»ªè¡¨æ¿æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ WafController.php      # WAFç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ RuleController.php     # è§„åˆ™ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ LogController.php      # æ—¥å¿—ç®¡ç†æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ app/admin/routes/      # ç®¡ç†è·¯ç”±
â”‚   â”‚   â””â”€â”€ AdminRoutes.php
â”‚   â”œâ”€â”€ app/admin/middleware/  # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ AuthMiddleware.php
â”‚   â””â”€â”€ app/admin/helpers/     # è¾…åŠ©å‡½æ•°
â”‚       â””â”€â”€ helpers.php
â”‚
â”œâ”€â”€ ğŸ”Œ æ’ä»¶ç³»ç»Ÿ
â”‚   â””â”€â”€ plugins/waf/           # WAFè§„åˆ™æ’ä»¶
â”‚       â”œâ”€â”€ SqlInjectionRule.php
â”‚       â”œâ”€â”€ XssRule.php
â”‚       â”œâ”€â”€ RateLimitRule.php
â”‚       â””â”€â”€ IpBlacklistRule.php
â”‚
â””â”€â”€ âš™ï¸ é…ç½®ä¸æµ‹è¯•
    â”œâ”€â”€ config/                # é…ç½®æ–‡ä»¶
    â”œâ”€â”€ tests/                 # æµ‹è¯•ä»£ç 
    â””â”€â”€ docs/                  # æ–‡æ¡£
```

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ŒæˆåŠŸèƒ½

- [x] **åŸºç¡€æ¶æ„**ï¼šWorkerman + å¼‚æ­¥åç¨‹
- [x] **WAFæ ¸å¿ƒ**ï¼šæ£€æµ‹å¼•æ“ + å†³ç­–ç³»ç»Ÿ
- [x] **ä»£ç†åŠŸèƒ½**ï¼šåå‘ä»£ç† + è´Ÿè½½å‡è¡¡
- [x] **Webç•Œé¢**ï¼šç®¡ç†æ§åˆ¶å° + API
- [x] **ç™»å½•ç³»ç»Ÿ**ï¼šç”¨æˆ·è®¤è¯ + ä¼šè¯ç®¡ç†
- [x] **ç›‘æ§ç³»ç»Ÿ**ï¼šæ€§èƒ½åˆ†æ + æ—¥å¿—è®°å½•
- [x] **æµ‹è¯•æ¡†æ¶**ï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
- [x] **æ··åˆæ¶æ„**ï¼šåŒæ­¥æ ¸å¿ƒ + å¼‚æ­¥åå°
- [x] **ç¦»çº¿æ¨¡å¼**ï¼šæ— éœ€æ•°æ®åº“å³å¯è¿è¡Œ
- [x] **ä»£ç é‡æ„**ï¼šæ¨¡å—åŒ–æ¶æ„ + æ¸…æ™°ç»“æ„

### ğŸš€ æŠ€æœ¯äº®ç‚¹

- **æ··åˆæ¶æ„**ï¼šæ ¸å¿ƒåŠŸèƒ½åŒæ­¥å¤„ç†ï¼Œåå°ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šWAFå’Œç®¡ç†ç•Œé¢å®Œå…¨åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤
- **ç°ä»£åŒ–ç™»å½•**ï¼šåŸºäºFigmaè®¾è®¡çš„å“åº”å¼ç™»å½•ç•Œé¢
- **æ’ä»¶ç³»ç»Ÿ**ï¼šå¯æ‰©å±•è§„åˆ™å¼•æ“
- **Webç®¡ç†**ï¼šç°ä»£åŒ–ç®¡ç†ç•Œé¢
- **å®æ—¶ç›‘æ§**ï¼šå®Œæ•´çš„ç›‘æ§ä½“ç³»
- **ä¼ä¸šçº§**ï¼šç”Ÿäº§ç¯å¢ƒå°±ç»ª
- **ä»£ç é‡æ„**ï¼šæ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„

## ğŸ“š APIæ–‡æ¡£

### Webç®¡ç†ç•Œé¢

- **ç™»å½•é¡µé¢**ï¼š`GET /admin/login` - ç”¨æˆ·ç™»å½•ç•Œé¢
- **ç®¡ç†ä¸»é¡µ**ï¼š`GET /admin` - ç®¡ç†æ§åˆ¶å°ç•Œé¢
- **ä»ªè¡¨æ¿**ï¼š`GET /dashboard` - ä»ªè¡¨æ¿é¡µé¢
- **å¥åº·æ£€æŸ¥**ï¼š`GET /health` - ç³»ç»Ÿå¥åº·çŠ¶æ€

### è®¤è¯API

- **ç”¨æˆ·ç™»å½•**ï¼š`POST /admin/auth/login` - ç”¨æˆ·ç™»å½•
- **ç”¨æˆ·ç™»å‡º**ï¼š`GET /admin/auth/logout` - ç”¨æˆ·ç™»å‡º
- **ä¼šè¯æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€

### REST API

- **ä»ªè¡¨æ¿æ•°æ®**ï¼š`GET /api/dashboard` - è·å–ä»ªè¡¨æ¿æ•°æ®
- **æ€§èƒ½æŠ¥å‘Š**ï¼š`GET /api/performance?period=1h` - è·å–æ€§èƒ½æŠ¥å‘Š
- **å®‰å…¨æŠ¥å‘Š**ï¼š`GET /api/security?period=1d` - è·å–å®‰å…¨æŠ¥å‘Š
- **æ•°æ®å¯¼å‡º**ï¼š`GET /api/export?type=dashboard&format=json` - å¯¼å‡ºæ•°æ®

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "data": {
    "overview": {
      "total_requests": 1500,
      "blocked_requests": 50,
      "block_rate": 3.3
    },
    "performance": {
      "avg_response_time": 120,
      "throughput": 250
    }
  },
  "timestamp": 1640995200
}
```

## ğŸ³ Dockeréƒ¨ç½²

### ä½¿ç”¨Docker Compose

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f tiangang
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶é…ç½®
WAF_ENABLED=true
SERVER_HOST=0.0.0.0
SERVER_PORT=8787
BACKEND_URL=http://backend:8080
REDIS_HOST=redis
REDIS_PORT=6379
```

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### æ€§èƒ½ç›‘æ§

- **å“åº”æ—¶é—´**ï¼šæ¯«ç§’çº§æ£€æµ‹å“åº”
- **ååé‡**ï¼šé«˜å¹¶å‘è¯·æ±‚å¤„ç†
- **å†…å­˜ä½¿ç”¨**ï¼šèµ„æºä½¿ç”¨ç›‘æ§
- **é”™è¯¯ç‡**ï¼šå¼‚å¸¸è¯·æ±‚ç»Ÿè®¡

### æ—¥å¿—ç®¡ç†

- **è®¿é—®æ—¥å¿—**ï¼šè¯·æ±‚/å“åº”è®°å½•
- **å®‰å…¨æ—¥å¿—**ï¼šæ”»å‡»æ£€æµ‹è®°å½•
- **é”™è¯¯æ—¥å¿—**ï¼šç³»ç»Ÿå¼‚å¸¸è®°å½•
- **æ€§èƒ½æ—¥å¿—**ï¼šæ€§èƒ½æŒ‡æ ‡è®°å½•

### å‘Šè­¦é…ç½®

```php
// é…ç½®å‘Šè­¦é˜ˆå€¼
'monitoring' => [
    'alerts' => [
        'block_rate' => 0.1,      // 10% æ‹¦æˆªç‡å‘Šè­¦
        'response_time' => 1000,  // 1ç§’å“åº”æ—¶é—´å‘Šè­¦
        'error_rate' => 0.05,     // 5% é”™è¯¯ç‡å‘Šè­¦
    ]
]
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/tiangang-waf.git
cd tiangang-waf

# å®‰è£…ä¾èµ–
composer install

# è¿è¡Œæµ‹è¯•
php tests/run_all_tests.php

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
php start.php start
```

### ä»£ç è§„èŒƒ

- éµå¾ªPSR-12ä»£ç è§„èŒƒ
- ä½¿ç”¨PHP 8.3+ç‰¹æ€§
- ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•
- æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Š

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [Workerman](https://github.com/walkor/Workerman) - é«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶
- [pfinal-asyncio](https://github.com/pfinalclub/asyncio) - å¼‚æ­¥åç¨‹åº“
- [Monolog](https://github.com/Seldaek/monolog) - æ—¥å¿—å¤„ç†
- [Guzzle](https://github.com/guzzle/guzzle) - HTTPå®¢æˆ·ç«¯
